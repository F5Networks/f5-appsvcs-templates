bigipHideTemplate: true

virtual_base: &virtual_base
  contentType: application/json
  definitions: &virtual_base_def
    use_ipam:
      title: Use IPAM Provider
      description: Use an IP Address Management service to get an IP address
      type: boolean
      default: false
    virtual_address:
      title: Virtual Server IP Address
      description: This IP address, combined with the port you specify below, becomes
        the BIG-IP virtual server address and port, which clients use to access the application.
        The system uses this IP:Port for distributing requests to the web servers.
    virtual_address_ipam:
      title: Virtual Server IP Address from IPAM
      description: Select an IPAM Provider to get an IP address from.
        This IP address, combined with the port you specify below, becomes
        the BIG-IP virtual server address and port, which clients use to access the application.
        The system uses this IP:Port for distributing requests to the web servers.
      ipFromIpam: true
      default: ''
    virtual_port:
      title: Virtual Server Port
      default: 443

# default VS subtemplate
<<: *virtual_base
template: |
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              "{{app_name}}": {
                "virtualAddresses": [
                  {{#use_ipam}}
                    "{{virtual_address_ipam}}"
                  {{/use_ipam}}
                  {{^use_ipam}}
                    "{{virtual_address:f5:ipv4_ipv6}}"
                  {{/use_ipam}}
                ],
                "virtualPort": {{virtual_port:f5:port}}
              }
            }
          }
        }

# fastl4 subtemplate
fastl4: &fastl4
  <<: *virtual_base
  definitions: &fastl4_context_def
    <<: *virtual_base_def
    fastl4:
      title: Use fastL4 Protocol Profiles
      description: The FastL4 profile can increase virtual server performance and throughput by using the embedded Packet Velocity Acceleration (ePVA) chip to accelerate traffic.
      type: boolean
      default: false
    make_fastl4_profile:
      title: FAST-Generated fastL4 Protocol Profile
      description: Uncheck to use an existing BIG-IP fastL4 profile.
      type: boolean
      default: true
    fastl4_profile_name:
      title: fastL4 profile
      description: Select an existing BIG-IP fastL4 profile.
      type: string
      enumFromBigip: ltm/profile/fastl4
      default: "/Common/fastL4"
  template: |
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              "{{app_name}}": {
                "virtualAddresses": [
                  {{#use_ipam}}
                    "{{virtual_address_ipam}}"
                  {{/use_ipam}}
                  {{^use_ipam}}
                    "{{virtual_address:f5:ipv4_ipv6}}"
                  {{/use_ipam}}
                ],
                "virtualPort": {{virtual_port:f5:port}},
                {{#fastl4}}
                  "class": "Service_L4",
                  {{#make_fastl4_profile}}
                    "profileL4": "basic",
                  {{/make_fastl4_profile}}
                  {{^make_fastl4_profile}}
                    "profileL4": {
                      "bigip": "{{fastl4_profile_name}}"
                    },
                  {{/make_fastl4_profile}}
                {{/fastl4}}
              }
            }
          }
        }

# tcp subTemplate
tcp: 
  definitions: *fastl4_context_def
  template: |
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              "{{app_name}}": {
                {{#fastl4}}
                  "class": "Service_L4",
                {{/fastl4}}
                {{^fastl4}}
                  "class": "Service_TCP",
                {{/fastl4}}
                "virtualAddresses": [
                  {{#use_ipam}}
                    "{{virtual_address_ipam}}"
                  {{/use_ipam}}
                  {{^use_ipam}}
                    "{{virtual_address:f5:ipv4_ipv6}}"
                  {{/use_ipam}}
                ],
                "virtualPort": {{virtual_port:f5:port}},
                {{#fastl4}}
                  {{#make_fastl4_profile}}
                    "profileL4": "basic",
                  {{/make_fastl4_profile}}
                  {{^make_fastl4_profile}}
                    "profileL4": {
                      "bigip": "{{fastl4_profile_name}}"
                    },
                  {{/make_fastl4_profile}}
                {{/fastl4}}
              }
            }
          }
        }

# subtemplate with VS names unique to DNS template
dns:
  <<: *virtual_base
  definitions: 
    <<: *virtual_base_def
    virtual_port:
      title: Virtual Server Port
      default: 53
  template: |
      {
        "{{tenant_name}}": {
          "{{app_name}}": {
            "{{app_name}}_tcp": {
              {{#use_ipam}}
                "virtualAddresses": ["{{virtual_address_ipam}}"],
              {{/use_ipam}}
              {{^use_ipam}}
                "virtualAddresses": ["{{virtual_address:f5:ipv4_ipv6}}"],
              {{/use_ipam}}
              "virtualPort": {{virtual_port:f5:port}}
            },
            "{{app_name}}_udp": {
              {{#use_ipam}}
                "virtualAddresses": ["{{virtual_address_ipam}}"],
              {{/use_ipam}}
              {{^use_ipam}}
                "virtualAddresses": ["{{virtual_address:f5:ipv4_ipv6}}"],
              {{/use_ipam}}
              "virtualPort": {{virtual_port:f5:port}}
            }
          }
        }
      }