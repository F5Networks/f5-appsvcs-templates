contentType: application/json
definitions:
  title:
    title: ''
    description: '# HTTP Application Template'
    format: info
  tls_prereq: {}
  tenant_name: {}
  app_name: {}
  virtual_address: {}
  virtual_port: {}
  enable_redirect: {}
  enable_pool: {}
  make_pool: {}
  pool_name: {}
  pool_members:
    title: Server Addresses
    description: Add the IP address for each pool member.
  pool_port:
    title: Service port
    description: Specify the server port number.
    default: 80
  load_balancing_mode: {}
  slow_ramp_time: {}
  enable_monitor: {}
  make_monitor: {}
  monitor_name:
    enumFromBigip: 'ltm/monitor/http'
  enable_snat: {}
  snat_automap: {}
  make_snatpool: {}
  snatpool_name: {}
  snat_addresses: {}
  enable_persistence: {}
  persistence_type: {}
  enable_fallback_persistence: {}
  fallback_persistence_type: {}
  enable_tls_server: {}
  make_tls_server_profile: {}
  tls_server_profile_name: {}
  tls_cert_name: {}
  tls_key_name: {}
  enable_tls_client: {}
  make_tls_client_profile: {}
  tls_client_profile_name: {}
  make_http_profile: {}
  http_profile_name: {}
  x_forwarded_for: {}
  enable_acceleration: {}
  make_acceleration_profile: {}
  acceleration_profile_name: {}
  enable_compression: {}
  make_compression_profile: {}
  compression_profile_name: {}
  enable_multiplex: {}
  make_multiplex_profile: {}
  multiplex_profile_name: {}
  common_tcp_profile: {}
  make_tcp_profile: {}
  tcp_topology: {}
  tcp_profile_name: {}
  make_tcp_ingress_profile: {}
  tcp_ingress_topology: {}
  tcp_ingress_profile_name: {}
  make_tcp_egress_profile: {}
  tcp_egress_topology: {}
  tcp_egress_profile_name: {}
  irule_names: {}
  app_type_def:
    template: |
      {{#enable_tls_server:f5:enable_tls_server}}
        "template": "https",
      {{/enable_tls_server:f5:enable_tls_server}}
      {{^enable_tls_server:f5:enable_tls_server}}
        "template": "http",
      {{/enable_tls_server:f5:enable_tls_server}}
  app_pool_def:
    template: |
      {{#enable_pool:f5:enable_pool}}
        {{#make_pool:f5:make_pool}}
          "{{app_name:f5:app_name}}_pool": {
            "class": "Pool",
            "members": [{
              "serverAddresses": {{pool_members:f5:ipv4_array}},
              "servicePort": {{pool_port:f5:port}},
              "shareNodes": true
            }],
            "loadBalancingMode": "{{load_balancing_mode:f5:load_balancing_mode}}",
            "slowRampTime": {{slow_ramp_time:f5:slow_ramp_time}},
            {{#enable_monitor:f5:enable_monitor}}
              {{#make_monitor:f5:make_monitor}}
                {{#enable_tls_client:f5:enable_tls_client}}
                  "monitors": [ "https" ]
                {{/enable_tls_client:f5:enable_tls_client}}
                {{^enable_tls_client:f5:enable_tls_client}}
                  "monitors": [ "http" ]
                {{/enable_tls_client:f5:enable_tls_client}}
              {{/make_monitor:f5:make_monitor}}
              {{^make_monitor:f5:make_monitor}}
                "monitors": [{
                  "bigip": "{{monitor_name:f5:monitor_name}}"
                }]
              {{/make_monitor:f5:make_monitor}}
            {{/enable_monitor:f5:enable_monitor}}
          },
        {{/make_pool:f5:make_pool}}
      {{/enable_pool:f5:enable_pool}}
  app_snatpool_def:
    template: |
      {{#enable_snat:f5:enable_snat}}
        {{^snat_automap:f5:snat_automap}}
          {{#make_snatpool:f5:make_snatpool}}
            "{{app_name:f5:app_name}}_snatpool": {
              "class": "SNAT_Pool",
              "snatAddresses": {{snat_addresses:f5:snat_addresses}}
            },
          {{/make_snatpool:f5:make_snatpool}}
        {{/snat_automap:f5:snat_automap}}
      {{/enable_snat:f5:enable_snat}}
  app_tls_server_def:
    template: |
      {{#enable_tls_server:f5:enable_tls_server}}
        {{#make_tls_server_profile:f5:make_tls_server_profile}}
          "{{app_name:f5:app_name}}_tls_server": {
            "class": "TLS_Server",
            "certificates": [{ "certificate": "{{app_name:f5:app_name}}_certificate" }]
          },
          "{{app_name:f5:app_name}}_certificate": {
            "class": "Certificate",
            "certificate": { "bigip": "{{tls_cert_name:f5:tls_cert_name}}" },
            "privateKey": { "bigip": "{{tls_key_name:f5:tls_key_name}}" }
          },
        {{/make_tls_server_profile:f5:make_tls_server_profile}}
      {{/enable_tls_server:f5:enable_tls_server}}
  app_tls_client_def:
    template: |
      {{#enable_tls_client:f5:enable_tls_client}}
        {{#make_tls_client_profile:f5:make_tls_client_profile}}
          "{{app_name:f5:app_name}}_tls_client": {
            "class": "TLS_Client"
          },
        {{/make_tls_client_profile:f5:make_tls_client_profile}}
      {{/enable_tls_client:f5:enable_tls_client}}
  app_http_def:
    template: |
      {{#make_http_profile:f5:make_http_profile}}
        "{{app_name:f5:app_name}}_http": {
          "class": "HTTP_Profile",
          "xForwardedFor": {{x_forwarded_for:f5:x_forwarded_for}}
        },
      {{/make_http_profile:f5:make_http_profile}}
  service_type_def:
    template: |
      {{#enable_tls_server:f5:enable_tls_server}}
        "class": "Service_HTTPS",
      {{/enable_tls_server:f5:enable_tls_server}}
      {{^enable_tls_server:f5:enable_tls_server}}
        "class": "Service_HTTP",
      {{/enable_tls_server:f5:enable_tls_server}}
  service_redirect80_def:
    template: |
      {{#enable_tls_server:f5:enable_tls_server}}
        "redirect80": {{enable_redirect:f5:enable_redirect}},
      {{/enable_tls_server:f5:enable_tls_server}}
      {{^enable_tls_server:f5:enable_tls_server}}
        "redirect80": false,
      {{/enable_tls_server:f5:enable_tls_server}}
  service_pool_def:
    template: |
      {{#enable_pool:f5:enable_pool}}
        {{#make_pool:f5:make_pool}}
          "pool": "{{app_name:f5:app_name}}_pool",
        {{/make_pool:f5:make_pool}}
        {{^make_pool:f5:make_pool}}
          "pool": {
            "bigip": "{{pool_name:f5:pool_name}}"
          },
        {{/make_pool:f5:make_pool}}
      {{/enable_pool:f5:enable_pool}}
  service_snat_def:
    template: |
      {{#enable_snat:f5:enable_snat}}
        {{#snat_automap:f5:snat_automap}}
          "snat": "auto",
        {{/snat_automap:f5:snat_automap}}
        {{^snat_automap:f5:snat_automap}}
          {{#make_snatpool:f5:make_snatpool}}
            "snat": {
              "use": "{{app_name:f5:app_name}}_snatpool"
            },
          {{/make_snatpool:f5:make_snatpool}}
          {{^make_snatpool:f5:make_snatpool}}
            "snat": {
              "bigip": "{{snatpool_name:f5:snatpool_name}}"
            },
          {{/make_snatpool:f5:make_snatpool}}
        {{/snat_automap:f5:snat_automap}}
      {{/enable_snat:f5:enable_snat}}
  service_persistence_def:
    template: |
      {{#enable_persistence:f5:enable_persistence}}
        "persistenceMethods": ["{{persistence_type:f5:persistence_type}}"],
        {{#enable_fallback_persistence:f5:enable_fallback_persistence}}
          "fallbackPersistenceMethod": "{{fallback_persistence_type:f5:fallback_persistence_type}}",
        {{/enable_fallback_persistence:f5:enable_fallback_persistence}}
      {{/enable_persistence:f5:enable_persistence}}
      {{^enable_persistence:f5:enable_persistence}}
        "persistenceMethods": [],
      {{/enable_persistence:f5:enable_persistence}}
  service_tls_server_def:
    template: |
      {{#enable_tls_server:f5:enable_tls_server}}
        {{#make_tls_server_profile:f5:make_tls_server_profile}}
          "serverTLS": "{{app_name:f5:app_name}}_tls_server",
        {{/make_tls_server_profile:f5:make_tls_server_profile}}
        {{^make_tls_server_profile:f5:make_tls_server_profile}}
          "serverTLS": {
            "bigip": "{{tls_server_profile_name:f5:bigip_path}}"
          },
        {{/make_tls_server_profile:f5:make_tls_server_profile}}
      {{/enable_tls_server:f5:enable_tls_server}}
  service_tls_client_def:
    template: |
      {{#enable_tls_client:f5:enable_tls_client}}
        {{#make_tls_client_profile:f5:make_tls_client_profile}}
          "clientTLS": "{{app_name:f5:app_name}}_tls_client",
        {{/make_tls_client_profile:f5:make_tls_client_profile}}
        {{^make_tls_client_profile:f5:make_tls_client_profile}}
          "clientTLS": {
            "bigip": "{{tls_client_profile_name:f5:tls_client_profile_name}}"
          },
        {{/make_tls_client_profile:f5:make_tls_client_profile}}
      {{/enable_tls_client:f5:enable_tls_client}}
  service_http_def:
    template: |
      {{#make_http_profile:f5:make_http_profile}}
        "profileHTTP": {
          "use": "{{app_name:f5:app_name}}_http"
        },
      {{/make_http_profile:f5:make_http_profile}}
      {{^make_http_profile:f5:make_http_profile}}
        "profileHTTP": {
          "bigip": "{{http_profile_name:f5:http_profile_name}}"
        },
      {{/make_http_profile:f5:make_http_profile}}
  service_acceleration_def:
    template: |
      {{#enable_acceleration:f5:enable_acceleration}}
        {{#make_acceleration_profile:f5:make_acceleration_profile}}
          "profileHTTPAcceleration": "basic",
        {{/make_acceleration_profile:f5:make_acceleration_profile}}
        {{^make_acceleration_profile:f5:make_acceleration_profile}}
          "profileHTTPAcceleration": {
            "bigip": "{{acceleration_profile_name:f5:bigip_path}}"
          },
        {{/make_acceleration_profile:f5:make_acceleration_profile}}
      {{/enable_acceleration:f5:enable_acceleration}}
  service_compression_def:
    template: |
      {{#enable_compression:f5:enable_compression}}
        {{#make_compression_profile:f5:make_compression_profile}}
          "profileHTTPCompression": "basic",
        {{/make_compression_profile:f5:make_compression_profile}}
        {{^make_compression_profile:f5:make_compression_profile}}
          "profileHTTPCompression": {
            "bigip": "{{compression_profile_name:f5:compression_profile_name}}"
          },
        {{/make_compression_profile:f5:make_compression_profile}}
      {{/enable_compression:f5:enable_compression}}
  service_multiplex_def:
    template: |
      {{#enable_multiplex:f5:enable_multiplex}}
        {{#make_multiplex_profile:f5:make_multiplex_profile}}
          "profileMultiplex": "basic",
        {{/make_multiplex_profile:f5:make_multiplex_profile}}
        {{^make_multiplex_profile:f5:make_multiplex_profile}}
          "profileMultiplex": {
            "bigip": "{{multiplex_profile_name:f5:multiplex_profile_name}}"
          },
        {{/make_multiplex_profile:f5:make_multiplex_profile}}
      {{/enable_multiplex:f5:enable_multiplex}}
  service_tcp_def:
    template: |
      {{#common_tcp_profile:f5:common_tcp_profile}}
        {{#make_tcp_profile:f5:make_tcp_profile}}
          "profileTCP": "{{tcp_topology:f5:tcp_topology}}",
        {{/make_tcp_profile:f5:make_tcp_profile}}
        {{^make_tcp_profile:f5:make_tcp_profile}}
          "profileTCP": {
            "bigip": "{{tcp_profile_name:f5:tcp_profile_name}}"
          },
        {{/make_tcp_profile:f5:make_tcp_profile}}
      {{/common_tcp_profile:f5:common_tcp_profile}}
      {{^common_tcp_profile:f5:common_tcp_profile}}
      "profileTCP": {
          {{#make_tcp_ingress_profile:f5:make_tcp_ingress_profile}}
            "ingress": "{{tcp_ingress_topology:f5:tcp_ingress_topology}}",
          {{/make_tcp_ingress_profile:f5:make_tcp_ingress_profile}}
          {{^make_tcp_ingress_profile:f5:make_tcp_ingress_profile}}
            "ingress": {
              "bigip": "{{tcp_ingress_profile_name:f5:tcp_ingress_profile_name}}"
            },
          {{/make_tcp_ingress_profile:f5:make_tcp_ingress_profile}}
          {{#make_tcp_egress_profile:f5:make_tcp_egress_profile}}
            "egress": "{{tcp_egress_topology:f5:tcp_egress_topology}}"
          {{/make_tcp_egress_profile:f5:make_tcp_egress_profile}}
          {{^make_tcp_egress_profile:f5:make_tcp_egress_profile}}
            "egress": {
              "bigip": "{{tcp_egress_profile_name:f5:tcp_egress_profile_name}}"
            }
          {{/make_tcp_egress_profile:f5:make_tcp_egress_profile}}
       },
      {{/common_tcp_profile:f5:common_tcp_profile}}
parameters:
  persistence_type: cookie
  monitor_name: /Common/tcp
template: |
  {{title}}
  {{tls_prereq:f5_help_text:tls_prereq}}
  {
    "class": "ADC",
    "schemaVersion": "3.0.0",
    "id": "urn:uuid:a858e55e-bbe6-42ce-a9b9-0f4ab33e3bf7",
    "{{tenant_name:f5:tenant_name}}": {
      "class": "Tenant",
      "{{app_name:f5:app_name}}": {
        "class": "Application",
        {{> app_type_def}}
        {{> app_pool_def}}
        {{> app_snatpool_def}}
        {{> app_tls_server_def}}
        {{> app_tls_client_def}}
        {{> app_http_def}}
        "serviceMain": {
          {{> service_type_def}} 
          "virtualAddresses": ["{{virtual_address:f5:virtual_address}}"],
          "virtualPort": {{virtual_port:f5:virtual_port}},
          {{> service_redirect80_def}}
          {{> service_pool_def}}
          {{> service_snat_def}}
          {{> service_persistence_def}}
          {{> service_tls_server_def}}
          {{> service_tls_client_def}}
          {{> service_http_def}}
          {{> service_acceleration_def}}
          {{> service_compression_def}}
          {{> service_multiplex_def}}
          {{> service_tcp_def}}
          "iRules": [
            {{#irule_names:f5:irule_names}}
            { "bigip": {{ . }} },
            {{/irule_names:f5:irule_names}}
          ]
        }
      }
    }
  }
