contentType: application/json
definitions:
  tenant_name: {}
  app_name: {}
  virtual_address: {}
  virtual_port: {}
  enable_pool: {}
  make_pool: {}
  pool_name: {}
  pool_members: {}
  pool_port: {}
  load_balancing_mode: {}
  slow_ramp_time: {}
  enable_monitor: {}
  make_monitor: {}
  monitor_name:
    enumFromBigip: 'ltm/monitor/tcp'
  enable_snat: {}
  snat_automap: {}
  make_snatpool: {}
  snatpool_name: {}
  snat_addresses: {}
  enable_persistence:
    title: Persistence
    description: Ensures that client requests are directed to the same pool member throughout the life of a session or during subsequent sessions.
    type: boolean
  persistence_type:
    title: Specify the type of persistence.
  enable_fallback_persistence:
    title: Fallback Persistence
    description: Create a secondary, or fallback, persistence record for each new client connection.
    type: boolean
  fallback_persistence_type:
    title: Specify the type of fallback persistence.
  common_tcp_profile:
    title: Use the same TCP profile for ingress and egress traffic.
    type: boolean
  make_tcp_profile:
    title: Automatically manage the TCP profile.
    type: boolean
  tcp_topology:
    title: Specify the type of network that connects both clients and servers to the BIG-IP system.
  tcp_profile_name:
    title: Specify the name of an existing BIG-IP TCP profile.
    enumFromBigip: 'ltm/profile/tcp'
  make_tcp_ingress_profile:
    title: Automatically manage the ingress TCP profile.
    type: boolean
  tcp_ingress_topology:
    title: Specify the type of network that connects clients to the BIG-IP system.
  tcp_ingress_profile_name:
    title: Specify the name of an existing BIG-IP TCP profile for client-side context.
    enumFromBigip: 'ltm/profile/tcp'
  make_tcp_egress_profile:
    title: Automatically manage the egress TCP profile.
    type: boolean
  tcp_egress_topology:
    title: Specify the type of network that connects servers to the BIG-IP system.
  tcp_egress_profile_name:
    title: Specify the name of an existing BIG-IP TCP profile for server-side context.
    enumFromBigip: 'ltm/profile/tcp'
  irule_names:
    title: Specify the name of one or more iRules to attach.
    type: array
    uniqueItems: true
    items:
      type: string
      enumFromBigip: 'ltm/rule'
    default: []
  app_pool_def:
    template: |
      {{#enable_pool:f5:enable_pool}}
        {{#make_pool:f5:make_pool}}
          "{{app_name:f5:app_name}}_pool": {
            "class": "Pool",
            "members": [{
              "serverAddresses": {{pool_members:f5:pool_members}},
              "servicePort": {{pool_port:f5:pool_port}},
              "shareNodes": true
            }],
            "loadBalancingMode": "{{load_balancing_mode:f5:load_balancing_mode}}",
            "slowRampTime": {{slow_ramp_time:f5:slow_ramp_time}},
            {{#enable_monitor:f5:enable_monitor}}
              {{#make_monitor:f5:make_monitor}}
                "monitors": [ "tcp" ]
              {{/make_monitor:f5:make_monitor}}
              {{^make_monitor:f5:make_monitor}}
                "monitors": [{
                  "bigip": "{{monitor_name:f5:monitor_name}}"
                }]
              {{/make_monitor:f5:make_monitor}}
            {{/enable_monitor:f5:enable_monitor}}
          },
        {{/make_pool:f5:make_pool}}
      {{/enable_pool:f5:enable_pool}}
  app_snatpool_def:
    template: |
      {{#enable_snat:f5:enable_snat}}
        {{^snat_automap:f5:snat_automap}}
          {{#make_snatpool:f5:make_snatpool}}
            "{{app_name:f5:app_name}}_snatpool": {
              "class": "SNAT_Pool",
              "snatAddresses": {{snat_addresses:f5:snat_addresses}}
            },
          {{/make_snatpool:f5:make_snatpool}}
        {{/snat_automap:f5:snat_automap}}
      {{/enable_snat:f5:enable_snat}}
  service_pool_def:
    template: |
      {{#enable_pool:f5:enable_pool}}
        {{#make_pool:f5:make_pool}}
          "pool": "{{app_name:f5:app_name}}_pool",
        {{/make_pool:f5:make_pool}}
        {{^make_pool:f5:make_pool}}
          "pool": {
            "bigip": "{{pool_name:f5:pool_name}}"
          },
        {{/make_pool:f5:make_pool}}
      {{/enable_pool:f5:enable_pool}}
  service_snat_def:
    template: |
      {{#enable_snat:f5:enable_snat}}
        {{#snat_automap:f5:snat_automap}}
          "snat": "auto",
        {{/snat_automap:f5:snat_automap}}
        {{^snat_automap:f5:snat_automap}}
          {{#make_snatpool:f5:make_snatpool}}
            "snat": {
              "use": "{{app_name:f5:app_name}}_snatpool"
            },
          {{/make_snatpool:f5:make_snatpool}}
          {{^make_snatpool:f5:make_snatpool}}
            "snat": {
              "bigip": "{{snatpool_name:f5:snatpool_name}}"
            },
          {{/make_snatpool:f5:make_snatpool}}
        {{/snat_automap:f5:snat_automap}}
      {{/enable_snat:f5:enable_snat}}
  service_persistence_def:
    template: |
      {{#enable_persistence}}
        "persistenceMethods": ["{{persistence_type:f5:persistence}}"],
        {{#enable_fallback_persistence}}
          "fallbackPersistenceMethod": "{{fallback_persistence_type:f5:persistence}}",
        {{/enable_fallback_persistence}}
      {{/enable_persistence}}
  service_tcp_def:
    template: |
      {{#common_tcp_profile}}
        {{#make_tcp_profile}}
          "profileTCP": "{{tcp_topology:f5:topology}}",
        {{/make_tcp_profile}}
        {{^make_tcp_profile}}
          "profileTCP": {
            "bigip": "{{tcp_profile_name:f5:bigip_path}}"
          },
        {{/make_tcp_profile}}
      {{/common_tcp_profile}}
      {{^common_tcp_profile}}
      "profileTCP": {
          {{#make_tcp_ingress_profile}}
            "ingress": "{{tcp_ingress_topology:f5:topology}}",
          {{/make_tcp_ingress_profile}}
          {{^make_tcp_ingress_profile}}
            "ingress": {
              "bigip": "{{tcp_ingress_profile_name:f5:bigip_path}}"
            },
          {{/make_tcp_ingress_profile}}
          {{#make_tcp_egress_profile}}
            "egress": "{{tcp_egress_topology:f5:topology}}"
          {{/make_tcp_egress_profile}}
          {{^make_tcp_egress_profile}}
            "egress": {
              "bigip": "{{tcp_egress_profile_name:f5:bigip_path}}"
            }
          {{/make_tcp_egress_profile}}
       },
      {{/common_tcp_profile}}
parameters:
  virtual_port: 443
  enable_pool: true
  make_pool: true
  pool_name: ''
  pool_port: 80
  slow_ramp_time: 300
  enable_monitor: true
  make_monitor: true
  monitor_name: /Common/tcp
  enable_snat: true
  snat_automap: true
  make_snatpool: true
  snatpool_name: ''
  enable_persistence: true
  persistence_type: source-address
  enable_fallback_persistence: false
  fallback_persistence_type: source-address
  common_tcp_profile: false
  make_tcp_profile: true
  tcp_topology: lan
  tcp_profile_name: /Common/f5-tcp-progressive
  make_tcp_ingress_profile: true
  tcp_ingress_topology: wan
  tcp_ingress_profile_name: /Common/f5-tcp-progressive
  make_tcp_egress_profile: true
  tcp_egress_topology: lan
  tcp_egress_profile_name: /Common/f5-tcp-progressive
  irule_names: []
template: |
  {
    "class": "ADC",
    "schemaVersion": "3.0.0",
    "id": "urn:uuid:a858e55e-bbe6-42ce-a9b9-0f4ab33e3bf7",
    "{{tenant_name:f5:tenant_name}}": {
      "class": "Tenant",
      "{{app_name:f5:app_name}}": {
        "class": "Application",
        "template": "tcp",
        {{> app_pool_def}}
        {{> app_snatpool_def}}
        "serviceMain": {
          "class": "Service_TCP",
          "virtualAddresses": ["{{virtual_address:f5:virtual_address}}"],
          "virtualPort": {{virtual_port:f5:virtual_port}},
          {{> service_pool_def}}
          {{> service_snat_def}}
          {{> service_persistence_def}}
          {{> service_tcp_def}}
          "iRules": [{{irule_names::array}}]
        }
      }
    }
  }
