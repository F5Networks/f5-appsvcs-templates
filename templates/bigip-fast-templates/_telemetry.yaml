title: Telemetry
contentType: application/json
bigipHideTemplate: true
bigipDependencies:
  - ts
ts_base: 
  definitions: &ts_base
    enable_telemetry:
      title: Forward logs to Telemetry Streaming
      type: boolean
      default: false
    ts_partial_vs:
      template: >-
        "{{app_name}}": {
          "profileTrafficLog": {
            "use": "/Common/Shared/fast_telemetry_traffic_log_profile"
          }
        }
    ts_partial_template:
      template: >-
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              {{#enable_telemetry}}
                {{> ts_partial_vs}}
              {{/enable_telemetry}}
            }
          }
        }

asm: &ts_asm
  title: ASM Logging
  contentType: application/json
  bigipDependencies:
    - asm
  definitions: &ts_asm_def
    enable_telemetry:
      type: boolean
    ts_partial_asm_vs:
      template: >-
        "{{app_name}}": {
          "securityLogProfiles": [
            { "use": "/Common/Shared/fast_telemetry_asm_security_log_profile" }
          ]
        }
    ts_partial_asm_template:
      template: >-
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              {{#enable_telemetry}}
                {{> ts_partial_asm_vs}}
              {{/enable_telemetry}}
            }
          }
        }

afm: &ts_afm
  title: AFM Logging
  contentType: application/json
  bigipDependencies:
    - afm
    - asm
  definitions: &ts_afm_def
    enable_telemetry:
      type: boolean
    ts_partial_afm_vs:
      template: >-
        "{{app_name}}": {
          "securityLogProfiles": [
            { "use": "/Common/Shared/fast_telemetry_afm_security_log_profile" }
          ]
        }
    ts_partial_afm_template:
      template: >-
        {
          "{{tenant_name}}": {
            "{{app_name}}": {
              {{#enable_telemetry}}
                {{> ts_partial_afm_vs}}
              {{/enable_telemetry}}
            }
          }
        }

definitions: *ts_base
anyOf:
  - {}
  - <<: *ts_asm
    template: |
      {{> ts_partial_asm_template}}
  - <<: *ts_afm
    template: |
      {{> ts_partial_afm_template}}
template: |
    {{> ts_partial_template}}

dns:
  title: Telemetry
  contentType: application/json
  bigipHideTemplate: true
  bigipDependencies:
    - ts
  anyOf:
    - {}
    - <<: *ts_asm
      definitions: 
        <<: *ts_asm_def
        ts_partial_asm_vs:
          template: >-
            "{{app_name}}_tcp": {
              "securityLogProfiles": [
                { "use": "fast_telemetry_asm_security_log_profile" }
              ]
            },
            "{{app_name}}_udp": {
              "securityLogProfiles": [
                { "use": "fast_telemetry_asm_security_log_profile" }
              ]
            }
      template: |
        {{> ts_partial_asm_template}}
    - <<: *ts_afm
      definitions: 
        <<: *ts_afm_def
        ts_partial_afm_vs:
          template: >-
            "{{app_name}}_tcp": {
              "securityLogProfiles": [
                { "use": "fast_telemetry_afm_security_log_profile" }
              ]
            },
            "{{app_name}}_udp": {
              "securityLogProfiles": [
                { "use": "fast_telemetry_afm_security_log_profile" }
              ]
            }
      template: |
        {{> ts_partial_afm_template}}
  definitions: 
    <<: *ts_base
    ts_partial_vs:
      template: >-
        "{{app_name}}_tcp": {
          "profileTrafficLog": {
            "use": "fast_telemetry_traffic_log_profile"
          }
        },
        "{{app_name}}_udp": {
          "profileTrafficLog": {
            "use": "fast_telemetry_traffic_log_profile"
          }
        }
  template: |
      {{> ts_partial_template}}
